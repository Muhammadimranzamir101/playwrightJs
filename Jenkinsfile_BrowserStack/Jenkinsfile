pipeline {
    agent any
    try{
        nodejs = tool name: 'nodejs-14.17.6'
                    env.NODEJS_HOME = "${nodejs}"
                    env.PATH = "${env.NODEJS_HOME}/bin:${env.PATH}"
        stages {
        stage('build') {
            steps {
                checkout scm
                sh 'npm install' // <1>
            }
        }
        stage('chrome') {
            browserstack(credentialsId: 'Browserstack_credentials', localConfig: [localOptions: '--include-hosts *.*.com, *.*.com*, *.com, *.com* --force-local', localPath: '']) {
                try {
                    env.BROWSERSTACK_USERNAME = "${BROWSERSTACK_USERNAME}"
                    env.BROWSERSTACK_ACCESS_KEY = "${BROWSERSTACK_ACCESS_KEY}"
                    env.BROWSERSTACK_LOCAL_IDENTIFIER = "${BROWSERSTACK_LOCAL_IDENTIFIER}"
                    env.BUILD_NUMBER = "${BUILD_NUMBER}"

                    sh '''
                                        sh 'npx playwright test --project=chromium --retries=1
                                    '''
                                    } catch (error) {
                    error.printStackTrace()
                    println('Got an error')
                }
            }
        }
        stage('firefox') {
            steps {
                sh 'npx playwright test --project=headless_firefox'
            }
        }
        stage('webkit') {
            steps {
                sh 'npx playwright test --project=headless_webkit'
            }
        }
        }
    }
    catch{
         if (currentBuild.result == null) {
                        currentBuild.result = "FAILURE"   // sets the ordinal as 4 and boolean to false
                    }
                    emailext body: '${JELLY_SCRIPT,template="selenium-results"}', mimeType: 'text/html', recipientProviders: [[$class: 'CulpritsRecipientProvider'], [$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']], subject: '[JENKINS] ${JOB_BASE_NAME} failed', to: 'mimran@nisum.com'
                    throw error
    }

}
